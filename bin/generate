#!/usr/bin/env php
<?php

require __DIR__.'/../vendor/autoload.php';

use MyShoppress\DevOp\MustacheEnvy\InputFileParser;
use MyShoppress\DevOp\MustacheEnvy\OutputHandler;
use MyShoppress\DevOp\MustacheEnvy\Renderer;
use MyShoppress\DevOp\MustacheEnvy\TemplateFiles;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\SingleCommandApplication;
use Symfony\Component\Console\Style\SymfonyStyle;

(new SingleCommandApplication)
    ->setName('Generate')
    ->addOption('template-file','t', InputOption::VALUE_REQUIRED,'HandleBar or Mustache template file. This option can be omitted if template is provided in STDIN')
    ->addOption('input-file','i', InputOption::VALUE_IS_ARRAY | InputOption::VALUE_REQUIRED,'Read input from input file. Detect input type from the file extension: `yaml` or `yml` for YAML, `.env` for ENV and `.json` for JSON')
//    ->addOption('input-order',null,InputOption::VALUE_REQUIRED,'The order accepts the input. There are 3 types of inputs. "e" for env values, "k" for key/value pairs entered in the argument and "i" is in input file. Default value is "eki"','eki')
    ->addOption('output','o', InputOption::VALUE_REQUIRED,'Output the result into this file instead of stdout')
    ->addOption('clear-env','c',InputOption::VALUE_NONE,'By default ENV values are passed to the template engine. This flag prevents that')
    ->setCode(function(InputInterface  $input, OutputInterface  $output ){

        $parser = new InputParser();
        $envVars = $input->getOption('clear-env')  ? [] : $_SERVER;
        $parser
            ->addEnvValues($envVars)
            ->addKeyValuePairs($input->getArgument('input-values'))
        ;
        if ( $input->getOption('input-file') ) {
            $file = $input->getOption('input-file');
            if ( $input->getOption('input-section' )) {
                $file .= '?'.$input->getOption('input-section' );
            }
            $parser->addInputFile($file);
        }
        $parser->setOrder($input->getOption('input-order'));
        $values = $parser->getValues();
        $templateFile = $input->getOption('template-file');
        $template = TemplateFiles::createTemplate($templateFile !== null ? [$templateFile] : []);
        $renderer = new Renderer();
        $data = $renderer->render($template, $values);
        $outputFile = $input->getOption('output');
        if ( empty($outputFile) ) {
            $outputFile = 'php://stdout';
        }
        elseif ( is_dir($outputFile) || $outputFile === '1' ) {
            $outputDirectory = $outputFile === '1' ? dirname($templateFile) : $outputFile;
            $name = pathinfo($templateFile, PATHINFO_FILENAME);
            $outputFile = $outputDirectory."/".$name;
        }
        OutputHandler::output($outputFile, $data);
    })
    ->run();